define(["jquery","core/ajax","core/templates","core/notification","core/config","core/url"],function(a,b,c,d,e,f){var g={recordvote:function(g,h,i,j){var k=a(j.target).closest(".moodleoverflowpost").prev(),l=k.attr("id"),l=l.substring(1),m=b.call([{methodname:"mod_moodleoverflow_record_vote",args:{discussionid:g,postid:l,ratingid:h,sesskey:e.sesskey}}]);return m[0].done(function(b){var d=a(j.target).parent().parent();2==h?(d.children("a:first-of-type").children().attr("src",f.imageUrl("vote/upvoted","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",f.imageUrl("vote/downvote","moodleoverflow"))):1==h?(d.children("a:first-of-type").children().attr("src",f.imageUrl("vote/upvote","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",f.imageUrl("vote/downvoted","moodleoverflow"))):(d.children("a:first-of-type").children().attr("src",f.imageUrl("vote/upvote","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",f.imageUrl("vote/downvote","moodleoverflow"))),d.children("p").text(b.postrating),c.replaceNode(a(".user-details,.author").find('a[href*="id='+i+'"]').siblings("span"),"<span>"+b.raterreputation+"</span>",""),i!==b.ownerid&&c.replaceNode(a(".user-details,.author").find('a[href*="id='+b.ownerid+'"]').siblings("span"),"<span>"+b.ownerreputation+"</span>","");var e=a("#p"+l).parent(),g=e.attr("class"),k=new Date(e.find(".user-action-time").text());if("main"!==e.attr("role")&&e.children("div").first().attr("class").indexOf("status")<0&&"intend"!==g){var k=new Date(e.find(".user-action-time").text());if(1===h||20===h){var m,n,o=!1;e.nextAll().each(function(){if(m=a(this),n=parseInt(a(".votes p",this).text()),n<b.postrating||n===b.postrating&&k<new Date(m.find(".user-action-time").text()))return o=!0,!1}),o?(e.detach(),e.insertBefore(m)):m&&(e.detach(),e.insertAfter(m))}else{var p,n,o=!1;e.prevUntil(":not(.tmargin)").each(function(){if(p=a(this),n=parseInt(a(".votes p",this).text()),n>b.postrating||n===b.postrating&&k>new Date(p.find(".user-action-time").text()))return o=!0,!1}),o?(e.detach(),e.insertAfter(p)):p&&(e.detach(),e.insertBefore(p))}}a(window).scrollTop(a("#p"+l).offset().top)}).fail(d.exception),m},clickevent:function(b,c){a(".upvote").on("click",function(d){a(d.target).is("a")&&(d.target=a(d.target).children()),a(d.target).parent().attr("class").indexOf("active")>=0?g.recordvote(b,20,c,d):g.recordvote(b,2,c,d),a(d.target).parent().toggleClass("active"),a(d.target).parent().nextAll("a").removeClass("active")}),a(".downvote").on("click",function(d){a(d.target).is("a")&&(d.target=a(d.target).children()),a(d.target).parent().attr("class").indexOf("active")>=0?g.recordvote(b,10,c,d):g.recordvote(b,1,c,d),a(d.target).parent().toggleClass("active"),a(d.target).parent().prevAll("a").removeClass("active")})}};return g});