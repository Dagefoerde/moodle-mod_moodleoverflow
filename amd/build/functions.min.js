define(["jquery","core/ajax","core/templates","core/notification"],function(a,b,c,d){var e={recordvote:function(e,f,g,h){var i=a(h.target).closest(".moodleoverflowpost").prev(),j=i.attr("id"),j=j.substring(1),k=b.call([{methodname:"mod_moodleoverflow_record_vote",args:{discussionid:e,postid:j,ratingid:f,sesskey:M.cfg.sesskey}}]);return k[0].done(function(b){var d=a(h.target).parent().parent();2==f?(d.children("a:first-of-type").children().attr("src",M.util.image_url("vote/upvoted","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",M.util.image_url("vote/downvote","moodleoverflow"))):1==f?(d.children("a:first-of-type").children().attr("src",M.util.image_url("vote/upvote","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",M.util.image_url("vote/downvoted","moodleoverflow"))):(d.children("a:first-of-type").children().attr("src",M.util.image_url("vote/upvote","moodleoverflow")),d.children("a:nth-of-type(2)").children().attr("src",M.util.image_url("vote/downvote","moodleoverflow"))),d.children("p").text(b.postrating),c.replaceNode(a(".user-details,.author").find('a[href*="id='+g+'"]').siblings("span"),"<span>"+b.raterreputation+"</span>",""),g!==b.ownerid&&c.replaceNode(a(".user-details,.author").find('a[href*="id='+b.ownerid+'"]').siblings("span"),"<span>"+b.ownerreputation+"</span>","");var e=a("#p"+j).parent(),i=e.attr("class"),k=new Date(e.find(".user-action-time").text());if("main"!==e.attr("role")&&e.children("div").first().attr("class").indexOf("status")<0&&"intend"!==i){var k=new Date(e.find(".user-action-time").text());if(1===f||20===f){var l,m,n=!1;e.nextAll().each(function(){if(l=a(this),m=parseInt(a(".votes p",this).text()),m<b.postrating||m===b.postrating&&k<new Date(l.find(".user-action-time").text()))return n=!0,!1}),n?(e.detach(),e.insertBefore(l)):l&&(e.detach(),e.insertAfter(l))}else{var o,m,n=!1;e.prevUntil(":not(.tmargin)").each(function(){if(o=a(this),m=parseInt(a(".votes p",this).text()),m>b.postrating||m===b.postrating&&k>new Date(o.find(".user-action-time").text()))return n=!0,!1}),n?(e.detach(),e.insertAfter(o)):o&&(e.detach(),e.insertBefore(o))}}a(window).scrollTop(a("#p"+j).offset().top)}).fail(d.exception),k},clickevent:function(b,c){a(".upvote").on("click",function(d){a(d.target).is("a")&&(d.target=a(d.target).children()),a(d.target).parent().attr("class").indexOf("active")>=0?e.recordvote(b,20,c,d):e.recordvote(b,2,c,d),a(d.target).parent().toggleClass("active"),a(d.target).parent().nextAll("a").removeClass("active")}),a(".downvote").on("click",function(d){a(d.target).is("a")&&(d.target=a(d.target).children()),a(d.target).parent().attr("class").indexOf("active")>=0?e.recordvote(b,10,c,d):e.recordvote(b,1,c,d),a(d.target).parent().toggleClass("active"),a(d.target).parent().prevAll("a").removeClass("active")})}};return e});